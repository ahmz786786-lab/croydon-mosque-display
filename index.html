<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Croydon Mosque & Islamic Centre</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Amiri:wght@400;700&display=swap');

    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      font-family: 'Inter', sans-serif;
      background: #F2EDE7;
    }

    body {
      display: flex;
      flex-direction: column;
    }

    /* ── HEADER ── */
    .header {
      background: #6E1E2C;
      padding: 1.5vh 0;
      text-align: center;
      position: relative;
    }

    .header img {
      height: 5vh;
      filter: brightness(0) invert(1);
    }

    /* ── CLOCK + DATES ── */
    .clock-section {
      background: linear-gradient(180deg, #6E1E2C 0%, #5A1522 60%, #4D1120 100%);
      text-align: center;
      padding: 1.5vh 0 2vh;
    }

    .clock {
      font-size: 12vh;
      font-weight: 800;
      color: #FFFFFF;
      line-height: 1;
      letter-spacing: -1px;
      font-variant-numeric: tabular-nums;
    }

    .date-row {
      margin-top: 1vh;
    }

    .gregorian-date {
      font-size: 2.8vh;
      color: rgba(255,255,255,0.8);
      font-weight: 400;
    }

    .hijri-date {
      font-family: 'Amiri', serif;
      font-size: 3vh;
      color: #D4A843;
      font-weight: 700;
      margin-top: 0.4vh;
      direction: rtl;
    }

    /* ── PRAYER TABLE ── */
    .prayer-table-wrap {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 1.5vh 3vw 0;
      min-height: 0;
    }

    .prayer-card {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #FFFFFF;
      border-radius: 1.5vh;
      overflow: hidden;
      box-shadow: 0 2px 16px rgba(0,0,0,0.08);
      border: 1px solid #E8E2DA;
      min-height: 0;
    }

    /* Table header */
    .t-head {
      background: #6E1E2C;
      display: grid;
      grid-template-columns: 1.8fr 1fr 1fr;
      padding: 1.2vh 4vw;
      align-items: center;
    }

    .t-head span {
      font-size: 2vh;
      font-weight: 700;
      color: rgba(255,255,255,0.85);
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    .t-head span:first-child { text-align: left; }
    .t-head span:not(:first-child) { text-align: center; }

    /* Prayer rows */
    .p-row {
      display: grid;
      grid-template-columns: 1.8fr 1fr 1fr;
      align-items: center;
      padding: 0 4vw;
      border-bottom: 1px solid #F0EBE4;
      flex: 1;
      min-height: 0;
      transition: background 0.3s;
    }

    .p-row:last-child { border-bottom: none; }

    .p-row.active {
      background: #FDF6ED;
      position: relative;
    }

    .p-row.active::before {
      content: '';
      position: absolute;
      left: 0; top: 0; bottom: 0;
      width: 0.5vw;
      background: #D4A843;
    }

    .p-name {
      font-size: 3.5vh;
      font-weight: 700;
      color: #2C2C2C;
      text-transform: uppercase;
      letter-spacing: 1px;
      display: flex;
      align-items: center;
      gap: 1.5vw;
    }

    .badge-next {
      display: none;
      font-size: 1.1vh;
      font-weight: 800;
      color: #FFFFFF;
      background: #4CAF50;
      padding: 0.3vh 1vw;
      border-radius: 0.5vh;
      letter-spacing: 0.5px;
    }

    .p-row.active .badge-next { display: inline-block; }

    .p-start, .p-iqamah { text-align: center; }

    .p-start .main {
      font-size: 3.5vh;
      font-weight: 500;
      color: #555;
      font-variant-numeric: tabular-nums;
    }

    .p-start .tomorrow { display: none; }

    .p-iqamah .main {
      font-size: 3.5vh;
      font-weight: 800;
      color: #6E1E2C;
      font-variant-numeric: tabular-nums;
    }

    .p-iqamah .tomorrow { display: none; }

    /* ── JUMUAH ROW ── */
    .jumuah-row {
      display: grid;
      grid-template-columns: 1.8fr 1fr 1fr;
      align-items: center;
      padding: 0 4vw;
      background: #FDFAF5;
      border-top: 2px solid #E8E2DA;
      flex: 1;
      min-height: 0;
    }

    .jumuah-row .p-name { color: #6E1E2C; }

    .jum-col { text-align: center; }

    .jum-label {
      font-size: 1.2vh;
      color: #6E1E2C;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .jum-val {
      font-size: 3.5vh;
      font-weight: 800;
      color: #6E1E2C;
      font-variant-numeric: tabular-nums;
    }

    /* ── BOTTOM: Sunrise / Ishraq / Zawaal ── */
    .bottom-row {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      padding: 1vh 3vw;
      gap: 1.5vw;
    }

    .bottom-item {
      text-align: center;
      background: #FFFFFF;
      border-radius: 1vh;
      padding: 1vh 0;
      border: 1px solid #E8E2DA;
    }

    .bottom-item .bl {
      font-size: 1.4vh;
      font-weight: 700;
      color: #6E1E2C;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .bottom-item .bv {
      font-size: 2.5vh;
      font-weight: 700;
      color: #6E1E2C;
      font-variant-numeric: tabular-nums;
    }

    /* ── FOOTER ── */
    .footer {
      background: #6E1E2C;
      padding: 0.8vh 3vw;
      text-align: center;
    }

    .footer-text {
      font-size: 1.2vh;
      color: rgba(255,255,255,0.4);
      font-weight: 500;
      letter-spacing: 1px;
    }

    /* Pulse */
    @keyframes glow {
      0%, 100% { background: #FDF6ED; }
      50% { background: #FFF0D4; }
    }
    .p-row.iqamah-soon { animation: glow 2s ease-in-out infinite; }

    /* ── SETTINGS GEAR BUTTON ── */
    .settings-gear {
      position: absolute;
      top: 1.2vh;
      right: 2vw;
      background: none;
      border: none;
      color: rgba(255,255,255,0.25);
      font-size: 2.5vh;
      cursor: pointer;
      padding: 0.5vh;
      z-index: 100;
    }

    /* ── SETTINGS MODAL ── */
    .settings-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .settings-overlay.open { display: flex; }

    .settings-panel {
      background: #F2EDE7;
      border-radius: 2vh;
      width: 90vw;
      max-width: 500px;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 8px 40px rgba(0,0,0,0.4);
    }

    .settings-header {
      background: #6E1E2C;
      padding: 2vh 3vw;
      border-radius: 2vh 2vh 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .settings-header h2 {
      color: #fff;
      font-size: 2.5vh;
      font-weight: 700;
    }

    .settings-close {
      background: none;
      border: none;
      color: rgba(255,255,255,0.6);
      font-size: 3vh;
      cursor: pointer;
    }

    .settings-body { padding: 2vh 3vw 1vh; }

    .settings-section {
      margin-bottom: 2vh;
    }

    .settings-section h3 {
      font-size: 1.6vh;
      font-weight: 700;
      color: #6E1E2C;
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-bottom: 1vh;
      border-bottom: 2px solid #D4A843;
      padding-bottom: 0.5vh;
    }

    .s-field {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1vh;
    }

    .s-field label {
      font-size: 1.6vh;
      font-weight: 500;
      color: #333;
    }

    .s-field input[type="time"],
    .s-field input[type="text"],
    .s-field input[type="number"],
    .s-field select {
      font-family: 'Inter', sans-serif;
      font-size: 1.5vh;
      padding: 0.6vh 1vw;
      border: 1px solid #ccc;
      border-radius: 0.8vh;
      background: #fff;
      color: #333;
      width: 45%;
    }

    .s-field input[type="checkbox"] {
      width: 2vh;
      height: 2vh;
      accent-color: #6E1E2C;
    }

    .settings-footer {
      display: flex;
      gap: 1.5vw;
      padding: 1.5vh 3vw 2.5vh;
    }

    .btn-save, .btn-cancel, .btn-reset {
      flex: 1;
      padding: 1.2vh 0;
      border: none;
      border-radius: 1vh;
      font-family: 'Inter', sans-serif;
      font-size: 1.5vh;
      font-weight: 700;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .btn-save {
      background: #6E1E2C;
      color: #fff;
    }

    .btn-cancel {
      background: #E8E2DA;
      color: #333;
    }

    .btn-reset {
      background: #D4A843;
      color: #fff;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

  <!-- Header -->
  <div class="header">
    <img src="logo.png" alt="Croydon Mosque & Islamic Centre">
    <button class="settings-gear" id="settingsGear">&#9881;</button>
  </div>

  <!-- Clock & Dates -->
  <div class="clock-section">
    <div class="clock"><span id="hours">08</span>:<span id="mins">40</span></div>
    <div class="date-row">
      <div class="gregorian-date" id="gregDate">Saturday 7 February 2026</div>
      <div class="hijri-date" id="hijriDate">١٨ شعبان ١٤٤٧</div>
    </div>
  </div>

  <!-- Prayer Table -->
  <div class="prayer-table-wrap">
    <div class="prayer-card">
      <div class="t-head">
        <span></span>
        <span>Start</span>
        <span>Iqamah</span>
      </div>

      <div class="p-row" id="row-fajr">
        <div class="p-name">Fajr <span class="badge-next">NEXT</span></div>
        <div class="p-start"><div class="main" id="start-fajr">5:35</div><div class="tomorrow" id="tmr-s-fajr"></div></div>
        <div class="p-iqamah"><div class="main" id="iq-fajr">6:30</div><div class="tomorrow" id="tmr-i-fajr"></div></div>
      </div>

      <div class="p-row" id="row-dhuhr">
        <div class="p-name">Dhuhr <span class="badge-next">NEXT</span></div>
        <div class="p-start"><div class="main" id="start-dhuhr">12:19</div><div class="tomorrow" id="tmr-s-dhuhr"></div></div>
        <div class="p-iqamah"><div class="main" id="iq-dhuhr">1:30</div><div class="tomorrow" id="tmr-i-dhuhr"></div></div>
      </div>

      <div class="p-row" id="row-asr">
        <div class="p-name">Asr <span class="badge-next">NEXT</span></div>
        <div class="p-start"><div class="main" id="start-asr">3:13</div><div class="tomorrow" id="tmr-s-asr"></div></div>
        <div class="p-iqamah"><div class="main" id="iq-asr">4:00</div><div class="tomorrow" id="tmr-i-asr"></div></div>
      </div>

      <div class="p-row" id="row-maghrib">
        <div class="p-name">Maghrib <span class="badge-next">NEXT</span></div>
        <div class="p-start"><div class="main" id="start-maghrib">5:07</div><div class="tomorrow" id="tmr-s-maghrib"></div></div>
        <div class="p-iqamah"><div class="main" id="iq-maghrib">5:07</div><div class="tomorrow" id="tmr-i-maghrib"></div></div>
      </div>

      <div class="p-row" id="row-isha">
        <div class="p-name">Isha <span class="badge-next">NEXT</span></div>
        <div class="p-start"><div class="main" id="start-isha">6:55</div><div class="tomorrow" id="tmr-s-isha"></div></div>
        <div class="p-iqamah"><div class="main" id="iq-isha">8:00</div><div class="tomorrow" id="tmr-i-isha"></div></div>
      </div>

      <!-- Jumuah -->
      <div class="jumuah-row">
        <div class="p-name">Jumu'ah</div>
        <div class="jum-col"><div class="jum-label">1st</div><div class="jum-val" id="jum1">12:25</div></div>
        <div class="jum-col"><div class="jum-label">2nd</div><div class="jum-val" id="jum2">1:25</div></div>
      </div>
    </div>
  </div>

  <!-- Bottom: Sunrise / Ishraq / Zawaal -->
  <div class="bottom-row">
    <div class="bottom-item"><div class="bl">Sunrise</div><div class="bv" id="sunrise">7:28</div></div>
    <div class="bottom-item"><div class="bl">Ishraq</div><div class="bv" id="ishraq">7:43</div></div>
    <div class="bottom-item"><div class="bl">Zawaal</div><div class="bv" id="zawaal">12:09</div></div>
  </div>

  <!-- Footer -->
  <div class="footer">
    <div class="footer-text">Croydon Mosque & Islamic Centre</div>
  </div>

  <!-- Settings Modal -->
  <div class="settings-overlay" id="settingsOverlay">
    <div class="settings-panel">
      <div class="settings-header">
        <h2>Settings</h2>
        <button class="settings-close" id="settingsClose">&times;</button>
      </div>
      <div class="settings-body">

        <div class="settings-section">
          <h3>Prayer Start Times</h3>
          <div class="s-field"><label>Auto-calculate from location</label><input type="checkbox" id="s-auto-calc" checked></div>
          <div id="manual-start-fields">
            <div class="s-field"><label>Fajr</label><input type="time" id="s-start-fajr"></div>
            <div class="s-field"><label>Dhuhr</label><input type="time" id="s-start-dhuhr"></div>
            <div class="s-field"><label>Asr</label><input type="time" id="s-start-asr"></div>
            <div class="s-field"><label>Maghrib</label><input type="time" id="s-start-maghrib"></div>
            <div class="s-field"><label>Isha</label><input type="time" id="s-start-isha"></div>
          </div>
        </div>

        <div class="settings-section">
          <h3>Iqamah Times</h3>
          <div class="s-field"><label>Fajr</label><input type="time" id="s-iq-fajr"></div>
          <div class="s-field"><label>Dhuhr</label><input type="time" id="s-iq-dhuhr"></div>
          <div class="s-field"><label>Asr</label><input type="time" id="s-iq-asr"></div>
          <div class="s-field"><label>Maghrib (auto)</label><input type="checkbox" id="s-iq-maghrib-auto" checked></div>
          <div class="s-field" id="s-iq-maghrib-field"><label>Maghrib</label><input type="time" id="s-iq-maghrib"></div>
          <div class="s-field"><label>Isha</label><input type="time" id="s-iq-isha"></div>
        </div>

        <div class="settings-section">
          <h3>Jumu'ah Times</h3>
          <div class="s-field"><label>1st Jumu'ah</label><input type="time" id="s-jum1"></div>
          <div class="s-field"><label>2nd Jumu'ah</label><input type="time" id="s-jum2"></div>
        </div>

        <div class="settings-section">
          <h3>Date & Time Display</h3>
          <div class="s-field"><label>Clock format</label>
            <select id="s-clock-format">
              <option value="24">24-hour</option>
              <option value="12">12-hour</option>
            </select>
          </div>
          <div class="s-field"><label>Date format</label>
            <select id="s-date-format">
              <option value="long">Saturday 7 February 2026</option>
              <option value="short">7 Feb 2026</option>
              <option value="numeric">07/02/2026</option>
            </select>
          </div>
          <div class="s-field"><label>Show Hijri date</label><input type="checkbox" id="s-show-hijri" checked></div>
          <div class="s-field"><label>Hijri date adjust (days)</label><input type="number" id="s-hijri-adjust" min="-2" max="2" value="0"></div>
        </div>

        <div class="settings-section">
          <h3>Location</h3>
          <div class="s-field"><label>Latitude</label><input type="number" id="s-lat" step="0.0001"></div>
          <div class="s-field"><label>Longitude</label><input type="number" id="s-lng" step="0.0001"></div>
          <div class="s-field"><label>Timezone</label><input type="text" id="s-tz"></div>
          <div class="s-field"><label>Asr method</label>
            <select id="s-asr-method">
              <option value="0">Standard</option>
              <option value="1">Hanafi</option>
            </select>
          </div>
          <div class="s-field"><label>Ishraq offset (min)</label><input type="number" id="s-ishraq-offset" min="0" max="30"></div>
        </div>

        <div class="settings-section">
          <h3>Display</h3>
          <div class="s-field"><label>Mosque name</label><input type="text" id="s-mosque-name"></div>
        </div>

      </div>
      <div class="settings-footer">
        <button class="btn-save" id="btnSave">Save</button>
        <button class="btn-cancel" id="btnCancel">Cancel</button>
        <button class="btn-reset" id="btnReset">Reset</button>
      </div>
    </div>
  </div>

  <script>
    /* ── SUPABASE ── */
    const SUPABASE_URL = 'https://ivcnzmuuaxvdyepimlgj.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml2Y256bXV1YXh2ZHllcGltbGdqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1NTk4MDgsImV4cCI6MjA4NjEzNTgwOH0.z3xAZ-nIuJdJAJIvY1WZ0XksGJV455c4EycWHyqD7fI';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    /* ── DEFAULT CONFIG ── */
    const DEFAULT_CONFIG = {
      iqamah: { fajr: [6,30], dhuhr: [13,30], asr: [16,0], maghrib: null, isha: [20,0] },
      manualStart: null,
      autoCalc: true,
      jumuah1: "12:25", jumuah2: "1:25",
      ishraqOffset: 15,
      lat: 51.3762, lng: -0.0986, tz: "Europe/London", asrMethod: 0,
      clockFormat: 24,
      dateFormat: "long",
      showHijri: true,
      hijriAdjust: 0,
      mosqueName: "Croydon Mosque & Islamic Centre",
    };

    function deepClone(o){ return JSON.parse(JSON.stringify(o)); }

    function mergeConfig(s){
      const c = deepClone(DEFAULT_CONFIG);
      Object.keys(s).forEach(k => {
        if(k === 'iqamah') Object.assign(c.iqamah, s.iqamah);
        else if(k === 'manualStart' && s.manualStart) c.manualStart = s.manualStart;
        else c[k] = s[k];
      });
      return c;
    }

    function loadConfig(){
      try {
        const saved = localStorage.getItem('mosqueConfig');
        if(saved) return mergeConfig(JSON.parse(saved));
      } catch(e){}
      return deepClone(DEFAULT_CONFIG);
    }

    const CONFIG = loadConfig();

    /* ── Supabase: fetch remote config on startup ── */
    async function fetchRemoteConfig(){
      try {
        const { data, error } = await sb.from('mosque_config').select('config').eq('id', 1).single();
        if(error) { console.error('Supabase fetch error:', error); return; }
        if(!data) { console.warn('No config row found in Supabase'); return; }
        console.log('Fetched remote config:', data.config);
        const remote = data.config;
        if(remote && Object.keys(remote).length > 0){
          const merged = mergeConfig(remote);
          Object.assign(CONFIG, merged);
          CONFIG.iqamah = merged.iqamah;
          localStorage.setItem('mosqueConfig', JSON.stringify(CONFIG));
          lastDay = '';
          update();
        }
      } catch(e){ console.error('Supabase fetch failed:', e); }
    }

    /* ── Supabase: real-time subscription ── */
    sb.channel('mosque-config-sync')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'mosque_config' }, (payload) => {
        console.log('Realtime update received:', payload);
        const remote = payload.new.config;
        if(remote && Object.keys(remote).length > 0){
          const merged = mergeConfig(remote);
          Object.assign(CONFIG, merged);
          CONFIG.iqamah = merged.iqamah;
          localStorage.setItem('mosqueConfig', JSON.stringify(CONFIG));
          lastDay = '';
          update();
          fetchFromWebsite();
        }
      })
      .subscribe((status) => {
        console.log('Realtime subscription status:', status);
      });

    async function saveToSupabase(config){
      try {
        const { data, error } = await sb.from('mosque_config').upsert({ id: 1, config: config, updated_at: new Date().toISOString() });
        if(error) console.error('Supabase save error:', error);
        else console.log('Saved to Supabase successfully');
      } catch(e){ console.error('Supabase save failed:', e); }
    }

    /* ── Fetch prayer times from Croydon Mosque website ── */
    let websiteTimes = null;
    let websiteTmrTimes = null;

    function parseCellTime(cell, isPM){
      const clone = cell.cloneNode(true);
      clone.querySelectorAll('input').forEach(i=>i.remove());
      const txt = clone.textContent.trim().replace(/[^\d:]/g,'');
      if(!txt) return null;
      const [h,m] = txt.split(':').map(Number);
      let hr = h;
      if(isPM && hr < 12) hr += 12;
      return hr + m/60;
    }

    function parseRow(row){
      if(!row) return null;
      const c = row.querySelectorAll('td');
      if(c.length < 13) return null;
      return {
        fajr: parseCellTime(c[3],false),
        fajrIq: parseCellTime(c[4],false),
        sunrise: parseCellTime(c[5],false),
        dhuhr: parseCellTime(c[6],true),
        dhuhrIq: parseCellTime(c[7],true),
        asr: parseCellTime(c[8],true),
        asrIq: parseCellTime(c[9],true),
        maghrib: parseCellTime(c[10],true),
        isha: parseCellTime(c[11],true),
        ishaIq: parseCellTime(c[12],true),
      };
    }

    function decToArr(dec){
      if(dec==null) return null;
      let hr=Math.floor(dec), mn=Math.round((dec-hr)*60);
      if(mn===60){hr++;mn=0;}
      return [hr,mn];
    }

    async function fetchFromWebsite(){
      try {
        const url = 'https://api.allorigins.win/raw?url='+encodeURIComponent('https://www.croydonmosque.com/?section=prayer');
        const resp = await fetch(url);
        if(!resp.ok) throw new Error('Fetch failed');
        const html = await resp.text();
        const doc = new DOMParser().parseFromString(html,'text/html');

        const todayRow = doc.querySelector('.rowToday');
        if(!todayRow) throw new Error('Today row not found');

        websiteTimes = parseRow(todayRow);
        websiteTmrTimes = parseRow(todayRow.nextElementSibling);

        if(websiteTimes){
          CONFIG.manualStart = {
            fajr: websiteTimes.fajr,
            dhuhr: websiteTimes.dhuhr,
            asr: websiteTimes.asr,
            maghrib: websiteTimes.maghrib,
            isha: websiteTimes.isha,
          };
          CONFIG.autoCalc = false;
          CONFIG.iqamah.fajr = decToArr(websiteTimes.fajrIq);
          if(websiteTimes.dhuhrIq) CONFIG.iqamah.dhuhr = decToArr(websiteTimes.dhuhrIq);
          if(websiteTimes.asrIq) CONFIG.iqamah.asr = decToArr(websiteTimes.asrIq);
          CONFIG.iqamah.maghrib = null;
          if(websiteTimes.ishaIq) CONFIG.iqamah.isha = decToArr(websiteTimes.ishaIq);

          // Parse Jumu'ah from sidebar
          const sidebar = doc.querySelector('#prayer-time-wrapper table');
          if(sidebar){
            const rows = sidebar.querySelectorAll('tr');
            rows.forEach(r=>{
              const cells = r.querySelectorAll('td');
              if(cells.length>=2){
                const label = cells[0].textContent.trim().toLowerCase();
                const val = cells[1].textContent.trim().replace(/\s*(am|pm)\s*/gi,'');
                if(label.includes('juma 1') || label.includes('jumu')) CONFIG.jumuah1 = val;
                if(label.includes('juma 2')) CONFIG.jumuah2 = val;
              }
            });
          }

          localStorage.setItem('mosqueConfig', JSON.stringify(CONFIG));
          lastDay = '';
          update();
          console.log('Prayer times updated from website:', websiteTimes);
        }
      } catch(e){ console.warn('Website fetch failed, using local times:', e); }
    }

    const toRad=d=>d*Math.PI/180, toDeg=r=>r*180/Math.PI;

    function calcTimes(date) {
      const lat=CONFIG.lat,lng=CONFIG.lng;
      const y=date.getFullYear(),mo=date.getMonth()+1,dy=date.getDate();
      let A=Math.floor((14-mo)/12),Y=y+4800-A,M=mo+12*A-3;
      let JD=dy+Math.floor((153*M+2)/5)+365*Y+Math.floor(Y/4)-Math.floor(Y/100)+Math.floor(Y/400)-32045;
      let D=JD-2451545.0,g=(357.529+0.98560028*D)%360,q=(280.459+0.98564736*D)%360;
      let L=(q+1.915*Math.sin(toRad(g))+0.020*Math.sin(toRad(2*g)))%360;
      let e=23.439-0.00000036*D;
      let RA=toDeg(Math.atan2(Math.cos(toRad(e))*Math.sin(toRad(L)),Math.cos(toRad(L))))/15;
      if(RA<0)RA+=24;
      let decl=toDeg(Math.asin(Math.sin(toRad(e))*Math.sin(toRad(L))));
      let EqT=q/15-RA;if(EqT>12)EqT-=24;
      const tz=(new Date(date.toLocaleString("en-US",{timeZone:CONFIG.tz}))-new Date(date.toLocaleString("en-US",{timeZone:"UTC"})))/3600000;
      let noon=12+tz-lng/15-EqT;
      const ha=a=>{let c=(Math.sin(toRad(a))-Math.sin(toRad(lat))*Math.sin(toRad(decl)))/(Math.cos(toRad(lat))*Math.cos(toRad(decl)));return(c>1||c<-1)?NaN:toDeg(Math.acos(c))/15;};
      let af=CONFIG.asrMethod===1?2:1;
      let asrAlt=toDeg(Math.atan(1/(af+Math.tan(toRad(Math.abs(lat-decl))))));
      let times={fajr:noon-ha(-18),sunrise:noon-ha(-0.833),zawaal:noon,dhuhr:noon+2/60,asr:noon+ha(asrAlt),maghrib:noon+ha(-0.833),isha:noon+ha(-17)};

      if(!CONFIG.autoCalc && CONFIG.manualStart){
        ['fajr','dhuhr','asr','maghrib','isha'].forEach(p=>{
          if(CONFIG.manualStart[p]!=null) times[p]=CONFIG.manualStart[p];
        });
      }
      return times;
    }

    function fmt(h){if(isNaN(h))return"--:--";let hr=Math.floor(h),mn=Math.round((h-hr)*60);if(mn===60){hr++;mn=0;}let h12=hr%12||12;return`${h12}:${mn.toString().padStart(2,'0')}`;}
    function fmt12(h){if(isNaN(h))return"--:--";let hr=Math.floor(h),mn=Math.round((h-hr)*60);if(mn===60){hr++;mn=0;}let ap=hr>=12?"PM":"AM",h12=hr%12||12;return`${h12}:${mn.toString().padStart(2,'0')} ${ap}`;}
    function iqFmt(p,sd){if(CONFIG.iqamah[p]===null)return fmt12(sd);let[h,m]=CONFIG.iqamah[p];let ap=h>=12?"PM":"AM";return`${h%12||12}:${m.toString().padStart(2,'0')} ${ap}`;}
    function iqShort(p,sd){if(CONFIG.iqamah[p]===null)return fmt(sd);let[h,m]=CONFIG.iqamah[p];return`${h%12||12}:${m.toString().padStart(2,'0')}`;}
    function iqDec(p,sd){if(CONFIG.iqamah[p]===null)return sd;let[h,m]=CONFIG.iqamah[p];return h+m/60;}

    function hijriAr(d, maghribDec){
      try{
        const adj = new Date(d);
        const now = adj.getHours() + adj.getMinutes()/60;
        if(maghribDec && now >= maghribDec) adj.setDate(adj.getDate() + 1);
        adj.setDate(adj.getDate() + (CONFIG.hijriAdjust||0));
        return new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',{day:'numeric',month:'long',year:'numeric'}).format(adj);
      }catch(e){return'';}
    }

    function formatGregorian(now){
      if(CONFIG.dateFormat==='short') return now.toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'});
      if(CONFIG.dateFormat==='numeric') return now.toLocaleDateString('en-GB',{day:'2-digit',month:'2-digit',year:'numeric'});
      return now.toLocaleDateString('en-GB',{weekday:'long',day:'numeric',month:'long',year:'numeric'});
    }

    const salah=['fajr','dhuhr','asr','maghrib','isha'];
    let today=null,tomorrow=null,lastDay='';

    function update(){
      const now=new Date(),day=now.toDateString();
      if(day!==lastDay){
        today=calcTimes(now);
        const tmr=new Date(now);tmr.setDate(tmr.getDate()+1);
        tomorrow=calcTimes(tmr);
        lastDay=day;

        document.getElementById('start-fajr').textContent=fmt(today.fajr);
        document.getElementById('start-dhuhr').textContent=fmt(today.dhuhr);
        document.getElementById('start-asr').textContent=fmt(today.asr);
        document.getElementById('start-maghrib').textContent=fmt(today.maghrib);
        document.getElementById('start-isha').textContent=fmt(today.isha);

        document.getElementById('iq-fajr').textContent=iqShort('fajr',today.fajr);
        document.getElementById('iq-dhuhr').textContent=iqShort('dhuhr',today.dhuhr);
        document.getElementById('iq-asr').textContent=iqShort('asr',today.asr);
        document.getElementById('iq-maghrib').textContent=iqShort('maghrib',today.maghrib);
        document.getElementById('iq-isha').textContent=iqShort('isha',today.isha);

        if(websiteTmrTimes){
          const tmrMap={fajr:websiteTmrTimes.fajr,dhuhr:websiteTmrTimes.dhuhr,asr:websiteTmrTimes.asr,maghrib:websiteTmrTimes.maghrib,isha:websiteTmrTimes.isha};
          salah.forEach(p=>{
            const t=fmt(today[p]),tm=fmt(tmrMap[p]);
            document.getElementById(`tmr-s-${p}`).textContent=(t!==tm)?tm:'';
          });
          const ti=fmt(today.maghrib),tmi=fmt(websiteTmrTimes.maghrib);
          document.getElementById('tmr-i-maghrib').textContent=(ti!==tmi)?tmi:'';
        } else {
          salah.forEach(p=>{
            const t=fmt(today[p]),tm=fmt(tomorrow[p]);
            document.getElementById(`tmr-s-${p}`).textContent=(t!==tm)?tm:'';
          });
          const ti=fmt(today.maghrib),tmi=fmt(tomorrow.maghrib);
          document.getElementById('tmr-i-maghrib').textContent=(ti!==tmi)?tmi:'';
        }

        document.getElementById('sunrise').textContent=fmt(today.sunrise);
        document.getElementById('ishraq').textContent=fmt(today.sunrise+CONFIG.ishraqOffset/60);
        document.getElementById('zawaal').textContent=fmt(today.zawaal);

        document.getElementById('gregDate').textContent=formatGregorian(now);
        const hijriEl = document.getElementById('hijriDate');
        if(CONFIG.showHijri){ hijriEl.style.display=''; hijriEl.textContent=hijriAr(now, today.maghrib); }
        else { hijriEl.style.display='none'; }

        document.getElementById('jum1').textContent=CONFIG.jumuah1;
        document.getElementById('jum2').textContent=CONFIG.jumuah2;

        document.querySelector('.footer-text').textContent=CONFIG.mosqueName;
      }

      const h=now.getHours(),m=now.getMinutes(),s=now.getSeconds();
      if(CONFIG.clockFormat===12){
        let h12=h%12||12;
        document.getElementById('hours').textContent=h12.toString();
        document.getElementById('mins').textContent=m.toString().padStart(2,'0');
      } else {
        document.getElementById('hours').textContent=h.toString().padStart(2,'0');
        document.getElementById('mins').textContent=m.toString().padStart(2,'0');
      }

      const cur=h+m/60+s/3600;
      let next=null,nextT=null;
      for(const p of salah){const jt=iqDec(p,today[p]);if(cur<jt){next=p;nextT=jt;break;}}
      if(!next){next='fajr';nextT=iqDec('fajr',today.fajr)+24;}

      let diff=(nextT-cur)*60;if(diff<0)diff+=1440;

      salah.forEach(p=>{
        const row=document.getElementById(`row-${p}`);
        row.classList.remove('active','iqamah-soon');
        if(p===next){row.classList.add('active');if(diff<=15)row.classList.add('iqamah-soon');}
      });
    }

    update();
    setInterval(update,1000);
    fetchRemoteConfig().then(() => fetchFromWebsite());
    setInterval(fetchFromWebsite, 3*60*60*1000);

    /* ── SETTINGS PANEL LOGIC ── */
    const overlay = document.getElementById('settingsOverlay');

    function decToTime(dec){
      if(dec==null||isNaN(dec)) return '';
      let hr=Math.floor(dec), mn=Math.round((dec-hr)*60);
      if(mn===60){hr++;mn=0;}
      return hr.toString().padStart(2,'0')+':'+mn.toString().padStart(2,'0');
    }
    function timeToArr(val){
      if(!val) return null;
      const [h,m]=val.split(':').map(Number);
      return [h,m];
    }
    function timeToDec(val){
      if(!val) return null;
      const [h,m]=val.split(':').map(Number);
      return h+m/60;
    }
    function arrToTime(arr){
      if(!arr) return '';
      return arr[0].toString().padStart(2,'0')+':'+arr[1].toString().padStart(2,'0');
    }
    function timeStr12(val){
      if(!val) return '';
      const [h,m]=val.split(':').map(Number);
      let h12=h%12||12;
      return h12+':'+m.toString().padStart(2,'0');
    }

    function openSettings(){
      // Populate form with current CONFIG
      document.getElementById('s-auto-calc').checked = CONFIG.autoCalc;
      const mf = document.getElementById('manual-start-fields');
      mf.style.display = CONFIG.autoCalc ? 'none' : '';

      if(CONFIG.manualStart){
        salah.forEach(p=>{
          document.getElementById('s-start-'+p).value = decToTime(CONFIG.manualStart[p]);
        });
      } else {
        salah.forEach(p=>{
          document.getElementById('s-start-'+p).value = today ? decToTime(today[p]) : '';
        });
      }

      document.getElementById('s-iq-fajr').value = arrToTime(CONFIG.iqamah.fajr);
      document.getElementById('s-iq-dhuhr').value = arrToTime(CONFIG.iqamah.dhuhr);
      document.getElementById('s-iq-asr').value = arrToTime(CONFIG.iqamah.asr);
      document.getElementById('s-iq-isha').value = arrToTime(CONFIG.iqamah.isha);

      const magAuto = CONFIG.iqamah.maghrib === null;
      document.getElementById('s-iq-maghrib-auto').checked = magAuto;
      document.getElementById('s-iq-maghrib-field').style.display = magAuto ? 'none' : '';
      document.getElementById('s-iq-maghrib').value = magAuto ? '' : arrToTime(CONFIG.iqamah.maghrib);

      document.getElementById('s-jum1').value = parseJumuahToTime(CONFIG.jumuah1);
      document.getElementById('s-jum2').value = parseJumuahToTime(CONFIG.jumuah2);

      document.getElementById('s-clock-format').value = CONFIG.clockFormat;
      document.getElementById('s-date-format').value = CONFIG.dateFormat;
      document.getElementById('s-show-hijri').checked = CONFIG.showHijri;
      document.getElementById('s-hijri-adjust').value = CONFIG.hijriAdjust;

      document.getElementById('s-lat').value = CONFIG.lat;
      document.getElementById('s-lng').value = CONFIG.lng;
      document.getElementById('s-tz').value = CONFIG.tz;
      document.getElementById('s-asr-method').value = CONFIG.asrMethod;
      document.getElementById('s-ishraq-offset').value = CONFIG.ishraqOffset;
      document.getElementById('s-mosque-name').value = CONFIG.mosqueName;

      overlay.classList.add('open');
    }

    function parseJumuahToTime(str){
      if(!str) return '';
      let parts = str.replace(/\s*(AM|PM)\s*/i,'').split(':');
      let h = parseInt(parts[0]), m = parseInt(parts[1]||'0');
      if(h<8) h+=12; // assume PM for small numbers like "1:25"
      return h.toString().padStart(2,'0')+':'+m.toString().padStart(2,'0');
    }

    function timeToJumuah(val){
      if(!val) return '';
      const [h,m] = val.split(':').map(Number);
      let h12 = h%12||12;
      return h12+':'+m.toString().padStart(2,'0');
    }

    function closeSettings(){ overlay.classList.remove('open'); }

    function saveSettings(){
      CONFIG.autoCalc = document.getElementById('s-auto-calc').checked;

      if(!CONFIG.autoCalc){
        CONFIG.manualStart = {};
        salah.forEach(p=>{
          const v = document.getElementById('s-start-'+p).value;
          CONFIG.manualStart[p] = v ? timeToDec(v) : null;
        });
      } else {
        CONFIG.manualStart = null;
      }

      CONFIG.iqamah.fajr = timeToArr(document.getElementById('s-iq-fajr').value);
      CONFIG.iqamah.dhuhr = timeToArr(document.getElementById('s-iq-dhuhr').value);
      CONFIG.iqamah.asr = timeToArr(document.getElementById('s-iq-asr').value);
      CONFIG.iqamah.isha = timeToArr(document.getElementById('s-iq-isha').value);

      if(document.getElementById('s-iq-maghrib-auto').checked){
        CONFIG.iqamah.maghrib = null;
      } else {
        CONFIG.iqamah.maghrib = timeToArr(document.getElementById('s-iq-maghrib').value);
      }

      CONFIG.jumuah1 = timeToJumuah(document.getElementById('s-jum1').value);
      CONFIG.jumuah2 = timeToJumuah(document.getElementById('s-jum2').value);

      CONFIG.clockFormat = parseInt(document.getElementById('s-clock-format').value);
      CONFIG.dateFormat = document.getElementById('s-date-format').value;
      CONFIG.showHijri = document.getElementById('s-show-hijri').checked;
      CONFIG.hijriAdjust = parseInt(document.getElementById('s-hijri-adjust').value)||0;

      CONFIG.lat = parseFloat(document.getElementById('s-lat').value);
      CONFIG.lng = parseFloat(document.getElementById('s-lng').value);
      CONFIG.tz = document.getElementById('s-tz').value;
      CONFIG.asrMethod = parseInt(document.getElementById('s-asr-method').value);
      CONFIG.ishraqOffset = parseInt(document.getElementById('s-ishraq-offset').value)||15;
      CONFIG.mosqueName = document.getElementById('s-mosque-name').value || DEFAULT_CONFIG.mosqueName;

      localStorage.setItem('mosqueConfig', JSON.stringify(CONFIG));
      saveToSupabase(JSON.parse(JSON.stringify(CONFIG)));
      lastDay = '';
      closeSettings();
      update();
    }

    function resetSettings(){
      localStorage.removeItem('mosqueConfig');
      Object.assign(CONFIG, deepClone(DEFAULT_CONFIG));
      CONFIG.iqamah = deepClone(DEFAULT_CONFIG.iqamah);
      saveToSupabase({});
      lastDay = '';
      closeSettings();
      update();
    }

    // Toggle manual start fields visibility
    document.getElementById('s-auto-calc').addEventListener('change', function(){
      document.getElementById('manual-start-fields').style.display = this.checked ? 'none' : '';
    });

    // Toggle maghrib iqamah field visibility
    document.getElementById('s-iq-maghrib-auto').addEventListener('change', function(){
      document.getElementById('s-iq-maghrib-field').style.display = this.checked ? 'none' : '';
    });

    // Button handlers
    document.getElementById('btnSave').addEventListener('click', saveSettings);
    document.getElementById('btnCancel').addEventListener('click', closeSettings);
    document.getElementById('settingsClose').addEventListener('click', closeSettings);
    document.getElementById('btnReset').addEventListener('click', resetSettings);

    // Click outside to close
    overlay.addEventListener('click', function(e){
      if(e.target === overlay) closeSettings();
    });

    // Keyboard: S to open, Escape to close
    document.addEventListener('keydown', function(e){
      if(e.key === 'Escape' && overlay.classList.contains('open')){
        closeSettings();
        return;
      }
      if((e.key === 's' || e.key === 'S') && !overlay.classList.contains('open')){
        const tag = document.activeElement.tagName;
        if(tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;
        openSettings();
      }
    });

    // Gear button to open settings (works on mobile and desktop)
    document.getElementById('settingsGear').addEventListener('click', openSettings);
  </script>
</body>
</html>